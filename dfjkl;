[1mdiff --git a/app/src/main/AndroidManifest.xml b/app/src/main/AndroidManifest.xml[m
[1mindex e36a67f..e4cf444 100644[m
[1m--- a/app/src/main/AndroidManifest.xml[m
[1m+++ b/app/src/main/AndroidManifest.xml[m
[36m@@ -161,7 +161,12 @@[m
 [m
         <activity android:name=".Activity.WayponitActivity" />[m
         <activity android:name=".Activity.FileActivity" />[m
[31m-        <activity android:name=".Activity.CompassActivity"></activity>[m
[32m+[m[32m        <activity android:name=".Activity.CompassActivity" />[m
[32m+[m
[32m+[m[32m        <service[m
[32m+[m[32m            android:name=".Activity.LocationService"[m
[32m+[m[32m            android:enabled="true"[m
[32m+[m[32m            android:exported="true"></service>[m
     </application>[m
 [m
 </manifest>[m
[1mdiff --git a/app/src/main/java/com/fanweilin/coordinatemap/Activity/MainActivity.java b/app/src/main/java/com/fanweilin/coordinatemap/Activity/MainActivity.java[m
[1mindex 9b96f3f..ada76b1 100644[m
[1m--- a/app/src/main/java/com/fanweilin/coordinatemap/Activity/MainActivity.java[m
[1m+++ b/app/src/main/java/com/fanweilin/coordinatemap/Activity/MainActivity.java[m
[36m@@ -36,13 +36,10 @@[m [mimport android.widget.RelativeLayout;[m
 import android.widget.Spinner;[m
 import android.widget.TextView;[m
 [m
[31m-import com.baidu.appx.BDBannerAd;[m
 import com.baidu.autoupdatesdk.BDAutoUpdateSDK;[m
 import com.baidu.autoupdatesdk.UICheckUpdateCallback;[m
 import com.baidu.location.BDLocation;[m
[31m-import com.baidu.location.BDLocationListener;[m
 import com.baidu.location.LocationClient;[m
[31m-import com.baidu.location.LocationClientOption;[m
 import com.baidu.mapapi.SDKInitializer;[m
 import com.baidu.mapapi.clusterutil.clustering.Cluster;[m
 import com.baidu.mapapi.clusterutil.clustering.ClusterItem;[m
[36m@@ -72,6 +69,7 @@[m [mimport com.baidu.mobstat.SendStrategyEnum;[m
 import com.baidu.mobstat.StatService;[m
 import com.fanweilin.coordinatemap.Class.LatStyle;[m
 import com.fanweilin.coordinatemap.Class.PointDataParcel;[m
[32m+[m[32mimport com.fanweilin.coordinatemap.EventBus.ServiceEvents;[m
 import com.fanweilin.coordinatemap.R;[m
 import com.fanweilin.coordinatemap.computing.ConvertLatlng;[m
 import com.fanweilin.coordinatemap.computing.DataItem;[m
[36m@@ -89,6 +87,8 @@[m [mimport java.text.DecimalFormat;[m
 import java.util.ArrayList;[m
 import java.util.List;[m
 [m
[32m+[m[32mimport de.greenrobot.event.EventBus;[m
[32m+[m
 public class MainActivity extends AppCompatActivity implements View.OnClickListener, BaiduMap.OnMapLoadedCallback {[m
     public Toolbar toolbar;[m
     public DrawerLayout drawerLayout;[m
[36m@@ -97,7 +97,6 @@[m [mpublic class MainActivity extends AppCompatActivity implements View.OnClickListe[m
     public BaiduMap mBaiduMap;[m
     public MapView mMapView;[m
     private Button btn_gone;[m
[31m-    public BDLocationListener myListener = new MyLocationListener();[m
     public double latitude;[m
     public double lontitude;[m
     public static String GETPOINTDATAPARCE="getpointdataparcel";[m
[36m@@ -119,14 +118,13 @@[m [mpublic class MainActivity extends AppCompatActivity implements View.OnClickListe[m
     private FloatingActionButton fabLocation;[m
     private View popupWindow;[m
     private BDLocation bdLocationForpw;[m
[31m-    private static String TAG = "AppX_BannerAd";[m
     private String address="";[m
     private String altitude="";[m
     private RelativeLayout appxBannerContainer;[m
[31m-   // private static BDBannerAd bannerAdView;[m
[31m-    private ProgressDialog dialog;[m
[32m+[m[32m     private ProgressDialog dialog;[m
      private static final String MARKBUNDLE="markbundle";[m
     AdView adView;[m
[32m+[m[32m    private LocationService locationService;[m
     @Override[m
     protected void onNewIntent(Intent intent) {[m
         super.onNewIntent(intent);[m
[36m@@ -147,21 +145,17 @@[m [mpublic class MainActivity extends AppCompatActivity implements View.OnClickListe[m
         mDrawerToggle = new ActionBarDrawerToggle(this, drawerLayout, toolbar, R.string.open, R.string.close) {[m
             public void onDrawerOpened(View drawerView) {[m
                 super.onDrawerOpened(drawerView);[m
[31m-                //mAnimationDrawable.stop();[m
             }[m
 [m
             @Override[m
             public void onDrawerClosed(View drawerView) {[m
                 super.onDrawerClosed(drawerView);[m
[31m-                // mAnimationDrawable.start();[m
             }[m
         };[m
         toolbar.setOnMenuItemClickListener(onMenuItemClickListener);[m
         mDrawerToggle.syncState();[m
         drawerLayout.setDrawerListener(mDrawerToggle);[m
[31m-        initLocation();[m
[31m-        mLocationClient.start();[m
[31m-        mLocationClient.registerLocationListener(myListener);[m
[32m+[m[32m        startService();[m
         showdata();[m
         dialog = new ProgressDialog(this);[m
         dialog.setIndeterminate(true);[m
[36m@@ -432,14 +426,21 @@[m [mpublic class MainActivity extends AppCompatActivity implements View.OnClickListe[m
         });[m
         startCount();[m
         //createBananer();[m
[31m-        createAD();[m
[32m+[m[32m        isshowBananer();[m
[32m+[m[32m        RegisterEventBus();[m
         imgLayerChange.setOnClickListener(this);[m
         imgClearall.setOnClickListener(this);[m
         imgMyloncation.setOnClickListener(this);[m
         fabLocation.setOnClickListener(this);[m
         btn_gone.setOnClickListener(this);[m
     }[m
[31m-[m
[32m+[m[32m       public void isshowBananer(){[m
[32m+[m[32m           if(data.time>=2){[m
[32m+[m[32m               createAD();[m
[32m+[m[32m           }else {[m
[32m+[m[32m               data.settime();[m
[32m+[m[32m           }[m
[32m+[m[32m       }[m
     public ClusterManager.OnClusterItemClickListener<MyItem> onClusterItemClickListener = new ClusterManager.OnClusterItemClickListener<MyItem>() {[m
         @Override[m
         public boolean onClusterItemClick(MyItem item) {[m
[36m@@ -463,51 +464,8 @@[m [mpublic class MainActivity extends AppCompatActivity implements View.OnClickListe[m
         }[m
     };[m
 [m
[31m-    private void initLocation() {[m
[31m-        LocationClientOption option = new LocationClientOption();[m
[31m-        option.setLocationMode(LocationClientOption.LocationMode.Hight_Accuracy[m
[31m-        );//å¯é€‰ï¼Œé»˜è®¤é«˜ç²¾åº¦ï¼Œè®¾ç½®å®šä½æ¨¡å¼ï¼Œé«˜ç²¾åº¦ï¼Œä½ŽåŠŸè€—ï¼Œä»…è®¾å¤‡[m
[31m-        option.setCoorType("gcj02");//å¯é€‰ï¼Œé»˜è®¤gcj02ï¼Œè®¾ç½®è¿”å›žçš„å®šä½ç»“æžœåæ ‡ç³»[m
[31m-        int span = 1000;[m
[31m-        option.setScanSpan(span);//å¯é€‰ï¼Œé»˜è®¤0ï¼Œå³ä»…å®šä½ä¸€æ¬¡ï¼Œè®¾ç½®å‘èµ·å®šä½è¯·æ±‚çš„é—´éš”éœ€è¦å¤§äºŽç­‰äºŽ1000msæ‰æ˜¯æœ‰æ•ˆçš„[m
[31m-        option.setIsNeedAddress(true);//å¯é€‰ï¼Œè®¾ç½®æ˜¯å¦éœ€è¦åœ°å€ä¿¡æ¯ï¼Œé»˜è®¤ä¸éœ€è¦[m
[31m-        option.setOpenGps(true);//å¯é€‰ï¼Œé»˜è®¤false,è®¾ç½®æ˜¯å¦ä½¿ç”¨gps[m
[31m-        option.setLocationNotify(true);//å¯é€‰ï¼Œé»˜è®¤falseï¼Œè®¾ç½®æ˜¯å¦å½“gpsæœ‰æ•ˆæ—¶æŒ‰ç…§1S1æ¬¡é¢‘çŽ‡è¾“å‡ºGPSç»“æžœ[m
[31m-        option.setIsNeedLocationDescribe(true);//å¯é€‰ï¼Œé»˜è®¤falseï¼Œè®¾ç½®æ˜¯å¦éœ€è¦ä½ç½®è¯­ä¹‰åŒ–ç»“æžœï¼Œå¯ä»¥åœ¨BDLocation.getLocationDescribeé‡Œå¾—åˆ°ï¼Œç»“æžœç±»ä¼¼äºŽâ€œåœ¨åŒ—äº¬å¤©å®‰é—¨é™„è¿‘â€[m
[31m-        option.setIsNeedLocationPoiList(true);//å¯é€‰ï¼Œé»˜è®¤falseï¼Œè®¾ç½®æ˜¯å¦éœ€è¦POIç»“æžœï¼Œå¯ä»¥åœ¨BDLocation.getPoiListé‡Œå¾—åˆ°[m
[31m-        option.setIgnoreKillProcess(false);//å¯é€‰ï¼Œé»˜è®¤falseï¼Œå®šä½SDKå†…éƒ¨æ˜¯ä¸€ä¸ªSERVICEï¼Œå¹¶æ”¾åˆ°äº†ç‹¬ç«‹è¿›ç¨‹ï¼Œè®¾ç½®æ˜¯å¦åœ¨stopçš„æ—¶å€™æ€æ­»è¿™ä¸ªè¿›ç¨‹ï¼Œé»˜è®¤æ€æ­»[m
[31m-        option.SetIgnoreCacheException(false);//å¯é€‰ï¼Œé»˜è®¤falseï¼Œè®¾ç½®æ˜¯å¦æ”¶é›†CRASHä¿¡æ¯ï¼Œé»˜è®¤æ”¶é›†[m
[31m-        option.setEnableSimulateGps(false);//å¯é€‰ï¼Œé»˜è®¤falseï¼Œè®¾ç½®æ˜¯å¦éœ€è¦è¿‡æ»¤gpsä»¿çœŸç»“æžœï¼Œé»˜è®¤éœ€è¦[m
[31m-        mLocationClient.setLocOption(option);[m
[31m-    }[m
     private LatLng bdLng = null;[m
 [m
[31m-    public class MyLocationListener implements BDLocationListener {[m
[31m-[m
[31m-        @Override[m
[31m-        public void onReceiveLocation(BDLocation location) {[m
[31m-            // test(location);[m
[31m-            bdLocationForpw = location;[m
[31m-[m
[31m-            LatLng gc02Lng = new LatLng(location.getLatitude(), location.getLongitude());[m
[31m-            converter.from(CoordinateConverter.CoordType.COMMON);[m
[31m-            converter.coord(gc02Lng);[m
[31m-            bdLng = converter.convert();[m
[31m-            if (latitude == 0.0) {[m
[31m-                latitude = bdLng.latitude;[m
[31m-                lontitude = bdLng.longitude;[m
[31m-                setMapCenter(latitude, lontitude);[m
[31m-            } else {[m
[31m-                latitude = bdLng.latitude;[m
[31m-                lontitude = bdLng.longitude;[m
[31m-            }[m
[31m-            showLocation(location, bdLng);[m
[31m-            if (popupWindow != null) {[m
[31m-                DisplayLocationInfo(popupWindow, location, bdLng);[m
[31m-            }[m
[31m-        }[m
[31m-[m
[31m-    }[m
 [m
     private void showLocation(BDLocation location, LatLng bdlat) {[m
         mBaiduMap.setMyLocationEnabled(true);[m
[36m@@ -579,6 +537,8 @@[m [mpublic class MainActivity extends AppCompatActivity implements View.OnClickListe[m
         BaiduMapNavigation.finish(this);[m
          dialog.dismiss();[m
         mMapView.onDestroy();//é”€æ¯åœ°å›¾[m
[32m+[m[32m        UnregisterEventBus();[m
[32m+[m[32m        stopService(serviceIntent);[m
         super.onDestroy();[m
     }[m
 [m
[36m@@ -1068,48 +1028,6 @@[m [mpublic class MainActivity extends AppCompatActivity implements View.OnClickListe[m
 [m
     }[m
 [m
[31m-//    private void createBananer() {[m
[31m-//        bannerAdView = new BDBannerAd(this, "liVzL2XTz0ComDCCTtB01gNBdOKvOoPx",[m
[31m-//                "5FTmGUDU0rFWg1meBLSO65tM");[m
[31m-//[m
[31m-//        // è®¾ç½®æ¨ªå¹…å¹¿å‘Šå±•ç¤ºå°ºå¯¸ï¼Œå¦‚ä¸è®¾ç½®ï¼Œé»˜è®¤ä¸ºSIZE_FLEXIBLE;[m
[31m-//        bannerAdView.setAdSize(BDBannerAd.SIZE_FLEXIBLE);[m
[31m-//[m
[31m-//        // è®¾ç½®æ¨ªå¹…å¹¿å‘Šè¡Œä¸ºç›‘å¬å™¨[m
[31m-//        bannerAdView.setAdListener(new BDBannerAd.BannerAdListener() {[m
[31m-//[m
[31m-//            @Override[m
[31m-//            public void onAdvertisementDataDidLoadFailure() {[m
[31m-//                Log.e(TAG, "load failure");[m
[31m-//            }[m
[31m-//[m
[31m-//            @Override[m
[31m-//            public void onAdvertisementDataDidLoadSuccess() {[m
[31m-//                Log.e(TAG, "load success");[m
[31m-//            }[m
[31m-//[m
[31m-//            @Override[m
[31m-//            public void onAdvertisementViewDidClick() {[m
[31m-//                Log.e(TAG, "on click");[m
[31m-//            }[m
[31m-//[m
[31m-//            @Override[m
[31m-//            public void onAdvertisementViewDidShow() {[m
[31m-//                Log.e(TAG, "on show");[m
[31m-//            }[m
[31m-//[m
[31m-//            @Override[m
[31m-//            public void onAdvertisementViewWillStartNewIntent() {[m
[31m-//                Log.e(TAG, "leave app");[m
[31m-//            }[m
[31m-//        });[m
[31m-//[m
[31m-//        // åˆ›å»ºå¹¿å‘Šå®¹å™¨[m
[31m-//        appxBannerContainer = (RelativeLayout) findViewById(R.id.appx_banner_container);[m
[31m-//[m
[31m-//        // æ˜¾ç¤ºå¹¿å‘Šè§†å›¾[m
[31m-//        appxBannerContainer.addView(bannerAdView);[m
[31m-//    }[m
 public void createAD(){[m
 [m
     AppActivity.setActionBarColorTheme(AppActivity.ActionBarColorTheme.ACTION_BAR_BLUE_THEME);[m
[36m@@ -1203,5 +1121,43 @@[m [mpublic void createAD(){[m
         pp.setFileid(files.getId());[m
         return pp;[m
     }[m
[32m+[m[32m    private void RegisterEventBus() {[m
[32m+[m[32m        EventBus.getDefault().registerSticky(this);[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    private void UnregisterEventBus(){[m
[32m+[m[32m        try {[m
[32m+[m[32m            EventBus.getDefault().unregister(this);[m
[32m+[m[32m        } catch (Throwable t){[m
[32m+[m[32m            //this may crash if registration did not go through. just be safe[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m[32m    public void onEventMainThread(ServiceEvents.LocationUpdate bdLocation){[m
[32m+[m[32m        BDLocation location=bdLocation.location;[m
[32m+[m[32m        bdLocationForpw = location;[m
[32m+[m[32m        LatLng gc02Lng = new LatLng(location.getLatitude(), location.getLongitude());[m
[32m+[m[32m        converter.from(CoordinateConverter.CoordType.COMMON);[m
[32m+[m[32m        converter.coord(gc02Lng);[m
[32m+[m[32m        bdLng = converter.convert();[m
[32m+[m[32m        if (latitude == 0.0) {[m
[32m+[m[32m            latitude = bdLng.latitude;[m
[32m+[m[32m            lontitude = bdLng.longitude;[m
[32m+[m[32m            setMapCenter(latitude, lontitude);[m
[32m+[m[32m        } else {[m
[32m+[m[32m            latitude = bdLng.latitude;[m
[32m+[m[32m            lontitude = bdLng.longitude;[m
[32m+[m[32m        }[m
[32m+[m[32m        showLocation(location, bdLng);[m
[32m+[m[32m        if (popupWindow != null) {[m
[32m+[m[32m            DisplayLocationInfo(popupWindow, location, bdLng);[m
[32m+[m[32m        }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    private  Intent serviceIntent;[m
[32m+[m[32m    public void startService(){[m
[32m+[m[32m            serviceIntent=new Intent();[m
[32m+[m[32m        serviceIntent.setClass(this,LocationService.class);[m
[32m+[m[32m        startService(serviceIntent);[m
[32m+[m[32m    }[m
 }[m
 [m
[1mdiff --git a/app/src/main/java/com/fanweilin/coordinatemap/Activity/data.java b/app/src/main/java/com/fanweilin/coordinatemap/Activity/data.java[m
[1mindex 01facfd..2cf16f7 100644[m
[1m--- a/app/src/main/java/com/fanweilin/coordinatemap/Activity/data.java[m
[1m+++ b/app/src/main/java/com/fanweilin/coordinatemap/Activity/data.java[m
[36m@@ -37,10 +37,12 @@[m [mpublic class data extends Application {[m
     public static String currentFilename;[m
     public static int currentCoordinate;[m
     public static int currentLatFormat;[m
[32m+[m[32m    public static int time;[m
     private final String Set="set";[m
     private static SharedPreferences spf;[m
     private SharedPreferences.Editor edit;[m
     private static final String FILENAME="filename";[m
[32m+[m[32m    private static final String TIME="time";[m
     private static final String COORDINATE="coorditnate";[m
     private static final String LATFORMAT="LATFORMAT";[m
     @Override[m
[36m@@ -49,7 +51,8 @@[m [mpublic class data extends Application {[m
         spf=getSharedPreferences(Set, Context.MODE_APPEND);[m
         currentFilename = spf.getString(FILENAME, "æˆ‘çš„æ”¶è—");[m
         currentCoordinate=spf.getInt(COORDINATE, WGS);[m
[31m-        currentLatFormat=spf.getInt(LATFORMAT,DEGREE);[m
[32m+[m[32m        currentLatFormat=spf.getInt(LATFORMAT, DEGREE);[m
[32m+[m[32m        time=spf.getInt(TIME,0);[m
         edit=spf.edit();[m
         setdata();[m
     }[m
[36m@@ -59,6 +62,12 @@[m [mpublic class data extends Application {[m
         edit.putString(FILENAME,currentFilename);[m
         edit.commit();[m
     };[m
[32m+[m[32m    public static void settime(){[m
[32m+[m[32m        SharedPreferences.Editor edit=spf.edit();[m
[32m+[m[32m        time++;[m
[32m+[m[32m        edit.putInt(TIME,time);[m
[32m+[m[32m        edit.commit();[m
[32m+[m[32m    };[m
     public static void setCurrentCoordinate(int coordinate){[m
         SharedPreferences.Editor edit=spf.edit();[m
         currentCoordinate=coordinate;[m
[1mdiff --git a/app/src/main/java/com/fanweilin/coordinatemap/widget/ZoomControlsView.java b/app/src/main/java/com/fanweilin/coordinatemap/widget/ZoomControlsView.java[m
[1mindex 9cafbb0..00c1571 100644[m
[1m--- a/app/src/main/java/com/fanweilin/coordinatemap/widget/ZoomControlsView.java[m
[1m+++ b/app/src/main/java/com/fanweilin/coordinatemap/widget/ZoomControlsView.java[m
[36m@@ -5,6 +5,7 @@[m [mimport android.support.v7.widget.CardView;[m
 import android.util.AttributeSet;[m
 import android.view.LayoutInflater;[m
 import android.view.View;[m
[32m+[m[32mimport android.widget.FrameLayout;[m
 import android.widget.ImageButton;[m
 import android.widget.RelativeLayout;[m
 [m
[36m@@ -39,7 +40,7 @@[m [mpublic class ZoomControlsView extends RelativeLayout implements View.OnClickList[m
 [m
     private void init() {[m
         LayoutInflater inflater = LayoutInflater.from(getContext());[m
[31m-        CardView view = (CardView) inflater.inflate(R.layout.zoom_controls, null);[m
[32m+[m[32m        FrameLayout view = (FrameLayout) inflater.inflate(R.layout.zoom_controls, null);[m
         zoomIn = (ImageButton) view.findViewById(R.id.btn_zoom_in);[m
         zoomOut = (ImageButton) view.findViewById(R.id.btn_zoom_out);[m
         zoomIn.setOnClickListener(this);[m
[1mdiff --git a/app/src/main/res/layout/activity_main_content.xml b/app/src/main/res/layout/activity_main_content.xml[m
[1mindex 679ece3..0f7d053 100644[m
[1m--- a/app/src/main/res/layout/activity_main_content.xml[m
[1m+++ b/app/src/main/res/layout/activity_main_content.xml[m
[36m@@ -104,6 +104,7 @@[m
     android:layout_height="wrap_content"[m
     android:layout_alignParentBottom="true">[m
     <Button[m
[32m+[m[32m        android:visibility="gone"[m
         android:id="@+id/btn_main_gone"[m
         android:layout_width="wrap_content"[m
         android:layout_alignParentRight="true"[m
[1mdiff --git a/app/src/main/res/menu/menu_main.xml b/app/src/main/res/menu/menu_main.xml[m
[1mindex 268e76a..08c3589 100644[m
[1m--- a/app/src/main/res/menu/menu_main.xml[m
[1m+++ b/app/src/main/res/menu/menu_main.xml[m
[36m@@ -10,9 +10,14 @@[m
     <item android:id="@+id/add_file"[m
         android:icon="@mipmap/ic_folder_open_white_48dp"[m
         android:title="@string/add_file"[m
[32m+[m[32m        android:orderInCategory="110"[m
         app:showAsAction="ifRoom" />[m
     <item android:id="@+id/menu_main_compass"[m
         android:icon="@mipmap/ic_gps_not_fixed_white_48dp"[m
         android:title="æŒ‡å—é’ˆ"[m
         app:showAsAction="ifRoom" />[m
[32m+[m[32m    <item android:id="@+id/menu_main_tool"[m
[32m+[m[32m        android:icon="@mipmap/ic_gps_not_fixed_white_48dp"[m
[32m+[m[32m        android:title="å·¥å…·"[m
[32m+[m[32m        app:showAsAction="ifRoom" />[m
 </menu>[m
